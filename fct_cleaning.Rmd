---
title: "fct_cleaning"
author: "LuciaSegovia"
date: "8/12/2020"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)

```


...NOTE:This is something where I need to improve this bit of code

```{r exploring sheets - loop}

#Loading FCT_QA data set

FCT_QA <- readxl::read_excel(here::here('data', 'FCT_QA.xlsx'), sheet = 2)

##TRIAL 1: This loop only works if all statements are = TRUE

sheet <- vector('double',  nrow(FCT_QA))

for(e in 1:nrow(FCT_QA)) {
  x <- paste(paste(FCT_QA[e,6]
                   , FCT_QA[e,2], sep = '_'), 'xlsx', sep = '.')
  
  sheet[[e]] <- readxl::excel_sheets(here::here( 'data',
                                                x)) %>% list()
}

sheet

```

Then, we can load those sheets of interest. For instance, for West Africa FCT we will use the sheet 2 ('02_Components') and sheet 5 ('05_sum_57 (per 100g EP)'). While for Kenya FCT, we might need sheet 2, 3 and 4.

Once we know what the information is provided by each FCT dataset, we realized that we can not extract all the information that we wanted. This is particularly true for Malawi, Lesotho and Nigeria FCTs because, even though we have access to a computer-readable format FCT, they do not provide any other information beside the food composition itself (i.e no metadata in tabular format was provided). Therefore, they need to be screened manually from their respective user-guides (pdf), when available.

For those FCT that provided extra-information (WAFCT, KENFCT, uFish, uPulses), we have extracted the information provided for the components description (labelled as '0x Components' for the four FCT). Since these four tables are using FAO tagnames we are going to use that tagnames as standardized way to name and/ refer to components throughout the project. 

####Standtadization of variables using FAO/INFOODS tagname

##1) West Africa FCT


For this section, we are going to calculate the missing values per MN of interest and the Sum of Proximates (SOP) calculated as ∑of water + protein + fat + available carbohydrates + dietary fibre + alcohol + ash. 

∑of WATER + PROTCNT + FAT + CHOAVLDF + FIBFG + ALC + ASH. 

In order to do so, we are going to standardize variables names as descibed above for food items names and code and for food components tagnames (FAO/INFOODS). Additionally, food groups will be standardized using FoodEx2 classification system.

UPDATE: Add rename to Energy variables folowing the standard that it is set below (MAFOODS) 
 +ENERC1 = ENERC...10 = Energy in kcal; 
 +ENERC2 = ENERC...10 = Energy in kJ).

```{r WAFCT standard variables}

##View WAFCT structure

readxl::read_excel(here::here('data', 
                              '2019_WAFCT.xlsx'), sheet = 5) %>% head()


##Loading WAFCT, skip 2 first rows to use tagnames for components

WAFCT <- readxl::read_excel(here::here( 'data', 
                                       '2019_WAFCT.xlsx'), sheet = 5, skip = 2) %>%
  mutate(FCT = 'WAFCT') %>% glimpse()


#rename variables according to our standards

WAFCT <- WAFCT %>% rename(code = '...1', 
                          fooditem = '...2', 
                          fooditemFR = '...3',
                          scientificName = '...4',
                          ref = '...5' ,
                          ENERC2 = 'ENERC...9', 
                          ENERC1 = 'ENERC...10') 


#creating variable 'foodgroups'

#Extracting variables names only in English

fgwa <- WAFCT %>% filter(is.na(fooditem), !is.na(code)) %>% pull(code) %>%
  stringr::str_split_fixed( '/', n = 2) %>% as_tibble() %>% pull(V1)


WAFCT <- WAFCT %>% 
  mutate(foodgroup = ifelse(grepl("01_", code), fgwa[1],
                            ifelse(grepl("02_", code), fgwa[2],
                                   ifelse(grepl("03_", code), fgwa[3], 
                                          ifelse(grepl("04_", code), fgwa[4], 
                                                 ifelse(grepl("05_", code), fgwa[5],
                                                        ifelse(grepl("06_", code), fgwa[6],
                                                               ifelse(grepl("07_", code),  fgwa[7],
                                                                      ifelse(grepl("08_", code), fgwa[8],
                                                                             ifelse(grepl("09_", code), fgwa[9], 
                                                                                    ifelse(grepl("10_", code), fgwa[10], 
                                                                                           ifelse(grepl("11_", code), fgwa[11],
                                                                                                  ifelse(grepl("12_", code),  fgwa[12],     
                                                                                                         ifelse(grepl("13_", code), fgwa[13],
                                                                                                                ifelse(grepl("14_", code), fgwa[14],
                                                                                                                       'NA'))))))))))))))) %>% 
  filter(!is.na(fooditem))

#Extracting variables calculated with different method and reported as using []


#This keeps [] 

#WAFCT <- WAFCT %>% mutate(FIBC = str_extract(FIBTG, "\\[.*?\\]"))


#This keeps only numbers

WAFCT <- WAFCT %>% mutate(FIBC = str_extract(FIBTG, '(?<=\\[).*?(?=\\])')) %>%
  mutate(FATCE = str_extract(FAT, '(?<=\\[).*?(?=\\])')) %>%
  mutate(TOCPHA = str_extract(VITE, '(?<=\\[).*?(?=\\])')) %>%
  mutate(FOLSUM = str_extract(FOL, '(?<=\\[).*?(?=\\])')) %>%
  mutate(PHYTCPPD_I = str_extract(PHYTCPP, '(?<=\\[).*?(?=\\])'))

#Reordering variables

WAFCT <- WAFCT %>% dplyr::relocate(foodgroup, .after = ref) %>%
  dplyr::relocate(FCT, .before = code)

#WE don't need this bit anymore
#WAFCT <- WAFCT[,c(64, 1:4, 65, 5:69)]


#Converting into numeric numeric variables  

WAFCT<- WAFCT %>% mutate_at(vars(8:69), funs(as.numeric)) 

#Calculating SOP for the WAFCT


WAFCT <- WAFCT %>%
  mutate(SOP = reduce(select(.,
                             'WATER', 'PROTCNT' ,'FAT', 'CHOAVLDF','FIBTG', 'ALC', 'ASH'), `+`))

summary(WAFCT$SOP)


```

NOTE: The problem with converting to numeric is that number between [] are removed (as NA). It is also creating a issue with the calculation of SOP


1) Tagnames standardization for MAFOODS

For WAFCT is already done. It only needs some minor refinement for those column that report two type of components (i.e. CARTBEQ or CARTB). However, for Malawi dataset all the variables names need to be converted manually. Why this need to be manually done, because there are three parameters that needs to be taken into account when re-naming them: 1) the compenent name, the unit and the method. I.e. for total nitrogen reported in grams and calculated with Kjeldahl method the tagname is NT

When we are doing the tagnames, we would look into 2010 tagnames, 2008 tagnames, 2007 tagnames. In that order. 

Decisions for tagnames in Malawi dataset

1) Energy reported as kcal (ENERC1), energy reported in kJ (ENERC2)

2) Nitrogen (g) = NT because it is reported in grams and it is mainly calculared by Kjeldahl method

3) Total protein (g) =  PROTCNT. Most of the values were calculated from total, nitrogen, In addition, following the advice on FAO/ INFOODS. 'PROCNT' is the appropriate tagname for total protein in most cases.

4) Total fat (g) = FAT (fat, total, Unit: g, Synonyms: total lipid). There are a mix of method on how fat has been calculated, including Soxhlet method that tends to underestimate content. However, since we are not currently differentiating between methods we will use the most generic version of the tagname. 
NOTE: in the future we could use FAT for normal and FATCE for continuous extraction 

5) Saturated FA (g) = FASAT (fatty acids, total saturated, Unit: g)

6) Mono-unsaturated FA (g) = FAMS (fatty acids, total monounsaturated, Unit: g)

7) Polyunsaturated FA (g) = FAPU (fatty acids, total polyunsaturated, Unit: g)

8) Cholesterol (mg) = CHOLC (cholesterol; determined by chemical method (classical), Unit: mg). We don't have information on how this variable has been obtained and we have chosen the 'classial' version. 
NOTE: This tagname could be updated in the future.

9) Total CHO for UDB = CHOTSM (carbohydrate, total; calculated by summation, Unit: g, Comments: This value is the sum of the, sugars, starches, oligosaccharides, and carbohydrate dietary fibre.). It was the only total CHO by summation. (CHOALVDF + Total Fibre)
UPDATE: We change CHOCSM to CHOCSM to make it consistent with FAO/INFOODS update for clarity where all the total carbohydrates are CHOT.

10) Carbohydrate, avail. (g) = CHOAVLDF (This value is calculated: 100 g minus total grams of water, protein, fat, alcohol, ash and dietary fibre; or CHOCDF – dietary fibre.)

11) Total sugar (g) = SUGAR (sugars, total, Unit: g, Comments: Sum of free monosaccharides and disaccharides.) From 2010 review tagnames, it is also suggested for sugars when the the method is unknown. 

12) Added sugar (g) = SUGAD (added sugar, Unit: g)

13) Total fibre (g) = FIBC (fibre, crude, Unit: g Comments: The crude fibre method of fibre analysis is obsolete.). Other methods were used as well. 
NOTE: This term needs to be reviewed

14) Starch (g) = STARCH (starch, total, Unit: g, Comments: The sum of all polysaccharides yielding glucose after hydrolysis with suitable enzymes; includes amylose, amylopectin, glycogen, and dextrins.The expression is unknown if by weight or in monosaccharide equivalent (2010)).

15) Ash (g) =  ASH (ash, Unit: g, Synonyms: minerals)

16) Ca (mg) = CA (calcium, Unit: mg)

17) Fe (mg) = FE (iron, total, Unit: mg, Comments: Includes both haem and non-haem iron.). We assume total iron since we have no extra information.

18) Mg (mg) = MG (magnesium, Unit: mg). This was the only entry available.

19) P (mg) = P (phosphorus, Unit: mg). This was the only entry available.

20) K (mg) = K (potassium, Unit: mg). This was the only entry available.

21) Na (mg) = NA (sodium, Unit: mg). This was the only entry available. 

22) Zn (mg) = ZN (zinc, Unit: mg). This was the only entry available.

23) Cu (mg) = CU (copper, Unit: mg). This was the only entry available.

24) Mn (mcg) = MN (manganese, Unit: mcg). This is the only entry available.

25) I (mcg) = ID (iodine, Unit: mcg). This is the only entry available.

26) Se (mcg) = SE (selenium, Unit mcg). This is the only entry available.

27) Vitamin A (RAE) (mcg) = VITA_RAE (Total vitamin A activity expressed in mcg retinol activity equivalent, Unit: mcg,  Comment RAE = mcg retinol+ 1/12 mcg ß- carotene + 1/24 mcg other provitamin A carotenoids (or RAE= mcg retinol + 1/12 mcg ß- carotene equivalent)

28) Vitamin A (RE) (mcg) = VITA (vitamin A; calculated by summation of the vitamin A activities of retinol and the active carotenoids, Unit: mcg. Synonyms: retinol equivalents. Comments: Total vitamin A activity = mcg retinol + 1/6 mcg beta-carotene + 1/12 mcg other provitamin A carotenoids.) As per the calculated in MAFOODS ((Retinol, µg/100g EP × 1) + (β-carotene, µg/100g EP ÷ 6) + (α-carotene, µg/ 100g EP ÷ 12) + (β-cryptoxanthin, µg/100g EP ÷ 12)).

29) Thiamin (mg) = THIA (thiamin, Unit: mg, Synonyms: vitamin B-1; aneurin; thiamine)

30) Riboflavin (mg) = RIBF ( riboflavin, Unit: mg, Synonyms: Vitamin B-2; riboflavine.). This is the only entry available.

31) Niacin (mg) = NIA (niacin, preformed, Unit: mg, Synonyms: nicotinic acid; nicotinamide (These terms are not true synonyms but are often used in food tables to refer to niacin.)). Since, we have no more information, we assume that it is niacin preformed. We could calculate NIAEQ if we have information tryptophan.

32) Vitamin B6 (mg) = VITB6 (vitamin B-6, total; method of determination unknown variable, Unit: mg, Comments: The <VITB6-> tagname should be used if it is not known whether  the vitamin B-6 value was determined by analysis or by calculation.). We use the generic version duet to lack of information on the method on how it has been calculated. 

33) Folic acid (mcg) = FOL (folate, total, Unit: mcg, Synonyms: folacin; folic acid, Comments: Includes both conjugated and free folate, Determined by microbiological assay)). This is the recommended expression. However, more information on how this component has been calculate should be provided.  
Note: Review this content with recently updated info. 

34) Vitamin B12 (mcg) = VITB12 (vitamin B-12, Unit: mcg, Synonyms: cobalamin, Comments: Includes all the active forms of vitamin B-12 in food.). This is the only entry available.

35) Pantothenate (mg) = PANTAC (pantothenic acid, Unit: mg, Synonyms: D-pantothenate; vitamin B-5 (obsolete term, may still appear in some tables)). This is the only entry available.

36) Biotin (mcg) = BIOT (biotin, Unit: mcg, Synonyms: vitamin H). This is the only entry available.

37) Vitamin C (mg) = VIT C (vitamin C, Unit: mg, Synonyms: ascorbic acid; ascorbate  (Note that these terms are not true synonyms but are often found in food tables to refer to vitamin C.), Comments: L-ascorbic acid plus L-dehydroascorbic acid.). We used this tagname because most of the method used to calculate vit. C were to calculate both fractions (total vit. C), as HPLC and spectro-photometric method. For the two other items that DCPIP was used, this were raw version of the food items, for this case vit C should be similar. Although it might be worth to check the impact of milling on L-ascorbic acid.

38) Vitamin D (mcg) = VITD (vitamin D; calculated by summation of ergocalciferol and cholecalciferol, Unit: mcg. Synonyms: calciferol, Comments: Ergocalciferol plus cholecalciferol.). Here, we should be using VITD- (vitamin D; method of determination unknown or variable, Comments: The <VITD-> tagname should be used if it is not known whether the vitamin D value was determined by bioassay or by calculation.)

39) Vitamin E (mg) = VITE (vitamin E; calculated by summation of the vitamin E activities of the active tocopherols and tocotrienols; expressed as alpha-tocopherol equivalents Unit: mg.). As with VITD, VITE- should be used as the method is unknown. 

40) Phytic Acid (mg) = PHYT (Phytic acid, unknown or variable method, Unit: mg). This should be PHYT-. It is the most generic version of phytic acid, since we have very little information on how it has been calculated.
Note: information on tagnames for phytates are in the S. Dahdouh et al. 2019. 


Note: Some of the generic tagname should be followed by '-' (dash), however since this character could cause some issues with the code, we have dropped the '-'.


```{r MAFOODS tagname}

##################------2) Malawi FCT----#####################


##View FCT structure
#Creating a variable for the names of the data-set 
# it is composed by 2 columns on the FCT_QA dataset
#Column 6 == Year
#Column 2 == Short_name
#Just need to input the number of the row (1-13)

x <- 2


readxl::read_excel(here::here( 'data', 
                              paste(paste(FCT_QA[x,6],
                                          FCT_QA[x,2], sep = '_'), 'xlsx', sep = '.')), sheet = 1) %>% head()


MAFOODS <- readxl::read_excel(here::here( 'data', 
                                         paste(paste(FCT_QA[x,6],
                                                     FCT_QA[x,2], sep = '_'), 'xlsx', sep = '.')), 
                              sheet = 1) %>% mutate(FCT = 'MAFOODS') %>% glimpse()

#Renaming variables with tagnames and converting numeric variables into numeric

FCT_tag <- c('code', 'ref', 'fooditem', 'foodgroup', 'WATER', 'ENERC1', 'ENERC2', 'NT',
             'PROTCNT', 'FAT', 'FASAT', 'FAMS', 'FAPU', 'CHOLC', 'CHOTSM', 'CHOAVLDF',
             'SUGAR', 'SUGAD', 'FIBC', 'STARCH', 'ASH', 'CA', 'FE', 'MG', 'P', 'K', 'NA',
             'ZN', 'CU', 'MN', 'ID', 'SE', 'VITA_RAE', 'VITA', 'THIA', 'RIBF', 'NIA', 'VITB6', 'FOL', 
             'VITB12', 'PANTAC', 'BIOT', 'VITC', 'VITD', 'VITE' ,'PHYT', 'FCT')


MAFOODS <- MAFOODS %>% rename_all( ~ FCT_tag) %>% mutate_at(vars(5:46), funs(as.numeric)) 

#Calculating SOP - Removing ALC and changing FIBTG for FIBC

MAFOODS <- MAFOODS %>%
  mutate(SOP = reduce(select(.,
                             'WATER', 'PROTCNT' ,'FAT', 'CHOAVLDF','FIBC',  'ASH'), `+`))

summary(MAFOODS$SOP)

```

#Ethiopia

5) Moisture (%): WATER (Unit: g). It is reported in %. 

9) CHO (inc. fiber) (g): CHOT (total carbohydrates, Unit: g). It is reported including fibre, hence it is 'total CHO'. Because the method is unknown we use the generic CHOT. 

10) Fiber (g): FIBTG (dietary fibre, Unit: g). We are going to assume that it is according to the standards and it is dietary fibre, until further clarification can be obtained. 

16) Beta-carotene Equiv. (mcg): CARTBEQ (beta-caroten equivalent, Unit: mcg). It is not recommended to be listed alone in the FCT. Since we are going to use VITA_RAE or VITA when possible. We can convert this variable to VITA_RAE and VITA by using the following equations. However, retinol information is missing in the ETHFCT.  

Eq.4:  VITA_RAE = mcg retinol + 1/12 mcg ß- carotene equivalent

Eq.5:  VITA = mcg retinol + 1/6 mcg ß- carotene equivalent

20) Tryptophan (mg) : TRP (L-tryptophan, Unit: mg)

21) Ascorbic acid (mg): We are going to assume that it is VitC. 

22) Refuse (%): REFUSE. It might be re-converted to EDIBLE portion to keep consistency

NOTE:Still need to arrange foodgroups


###Gambia

Within the GMBFCT there are tagnames assigned to each food component

4) Energy...4(kcal): ENERC1 (it should be ENERGYC, as per GMBFCT), this should be re-calculated as CHOAVL but it is not possible since we have no information to convert monosacharides information to weight. Hence, we are going to use it as it is and compared it with the other ENERC.

5) Energy...5 (kJ): ENERC2 (it should be ENERGYC, as per GMBFCT), this needs to be re-calculated as per kJ contribution per macronutrient.

8) Carbo-hydrate (g): CHOAVLM (Carbohydrates availables expresed as monosacharides equivalents, Unit: g). This can not be converted due to lack of information of the carbohydrates composition and can not be compared with available CHO in weight.

9) Fibre (g): FIBTS (total dietary fibre, sum of non-digestible polysaccharides and lignin, Unit: g). More information is needed to know how the estimates are affected by the method. 

10) Phytate (g): PHYTAC. I think it should be PHYPPCD - Phytic acid, based on phytate phosphorus estimated by direct ferric precipitation (Unit: mg) because it used FE precipitation. 

16) Carotene (mcg): CARBEQ (beta-caroten equivalent, Unit: mcg). As in ETHFCT, this should not be listed alone in the FCT.

Ash are not reported, we can see a slightly lower SOP when comparing it with MAFOODS and WAFCT.

```{r GBMFCT tagname }

#-4) Gambia FCT----#####################

#Gambia FCT - tagname standardization

#View FCT structure
#Creating a variable for the names of the data-set 
# it is composed by 2 columns on the FCT_QA dataset
#Column 6 == Year
#Column 2 == Short_name
#Just need to input the number of the row (1-13)

x <- 4


readxl::read_excel(here::here( 'data', 
                              paste(paste(FCT_QA[x,6],
                                          FCT_QA[x,2], sep = '_'), 'xlsx', sep = '.')), sheet = 1) %>%
  head()

#Customized saving FCT

GMBFCT <- readxl::read_excel(here::here( 'data', 
                                        paste(paste(FCT_QA[x,6],
                                                    FCT_QA[x,2], sep = '_'), 'xlsx', sep = '.')), 
                             sheet = 1) %>% mutate(FCT = 'GMBFCT') %>% glimpse()


FCT4_tag <- c('foodgroup','code',  'fooditem', 'ENERC1', 'ENERC2',  
              'PROTCNT', 'FAT',  'CHOAVLM', 'FIBTS', 'PHYTAC',
              'WATER', 'CA',  'P', 'FE',  'ZN', 'CARTBEQ', 'VITC',
              'ref', 'FCT')

#Renaming and converting into numeric (needed for binding datasets)

GMBFCT <- GMBFCT %>% rename_all( ~ FCT4_tag) %>% slice(3:527) %>%
  mutate_at(vars(4:17), funs(as.numeric)) 

#Converting into character (needed for binding datasets)

GMBFCT$code <- as.character(GMBFCT$code)

#SOP - changing CHOAVLDF to CHOAVLM, FIBTG to FIBTS, removing ALC, no ASH are included.

GMBFCT <- GMBFCT %>%
  mutate(SOP = reduce(select(.,
                             'WATER', 'PROTCNT' ,'FAT', 'CHOAVLM','FIBTS'), `+`))


```

####Kenya

Within this FCT there are a set of components with tagnames (majority of items not relevants for the project and with high amount of missing values) and other without. To facilitate the standardization of relevant component, we have cut the table in two

KENFCT1 - We have review and update tagnames and we have cut the rows until 1242 to be consistent with the number of food items reported. The two extra-rows removed contains information on FOLAC for some food items and an the following statement '**values between [ ] were borrowed from an average of blood from other animals'. Then tagnames were standardized following the standard names as described above and on FCT_QA, some decision point are described below: 

22) Retinol (mcg): RETOL (Retinol, Unit: mcg)

27-28) Folates group: According to the User-guide all four forms were reported (Dietary folate eq., food folate, synthetic folate, total folate). However when exploring the variables only two are present (dietary folate eq., and food folate). FOLAC is reported as comments or food notes for those food items that where fortified. An control check should be implemented for fortified food, since some of the fortified food (FOLDFE ≠ FOLDF) are not always stated in the 'fooditem' (name). FOL was not found in the user-guider nor in the xlsx format. 

KENFCT2 - We have incorporated tagnames as per in the dataset (with no modifications)

####Lesotho

4) Energy is only reported in kJ. New variable need to be created, for ENERC1.

We need to clean the table from missing values that were originated by the format of the table (double-spaces)

NOTE: I need to update the loop for foodgroup variable. None of the loops that I tried worked so far...

```{r LSOFCT tagname }

#View FCT structure
#Creating a variable for the names of the data-set 
# it is composed by 2 columns on the FCT_QA dataset
#Column 6 == Year
#Column 2 == Short_name
#Just need to input the number of the row (1-13)

x <- 6


readxl::read_excel(here::here(  'data', 
                                paste(paste(FCT_QA[x,6],
                                            FCT_QA[x,2], sep = '_'), 'xlsx', sep = '.')), sheet = 6) %>%
  head()

#Customized saving FCT

LSOFCT <- readxl::read_excel(here::here(  'data', 
                                           paste(paste(FCT_QA[x,6],
                                                       FCT_QA[x,2], sep = '_'), 'xlsx', sep = '.')), 
                              sheet = 6) %>% mutate(FCT = 'LSOFCT') %>%  select(2:41) %>% glimpse()

FCT6_tag <- c('code', 'fooditem', 'EDIBLE', 'ENERC2', 'WATER', 
               'CHOAVLDF', 'NT', 'PROTCNT', 'PROPLA', 'PROANI' , 'FIBTG', 'ASH', 'FAT',
              'CHOLE', 'FASAT', 'FAMS', 'FAPU', 'STARCH', 'SUGAR',
              'CA', 'FE', 'MG', 'P', 'K', 'NA', 'ZN','CU','SE', 'MN', 
              'VITA',  'CARBEQ', 'VITD', 'VITE', 
              'THIA', 'RIBF', 'NIA', 'VITB6'  ,'FOL', 'VITC', 'FCT')

LSOFCT <- LSOFCT %>% rename_all( ~ FCT6_tag) 

#creating variable 'foodgroups'

#Extracting variables names only in English

fglso <- LSOFCT %>% filter(is.na(code), !is.na(fooditem)) %>% pull(fooditem) %>%
  stringr::str_split_fixed( ' ', n = 2) %>% as_tibble()

nolso <- fglso %>%  pull(V1)

fglso <- fglso %>%  pull(V2)


LSOFCT <- LSOFCT %>% 
  mutate(foodgroup = ifelse(grepl(nolso[1], code), fglso[1],
                            ifelse(grepl(nolso[2], code), fglso[2],
                                   ifelse(grepl(nolso[3], code), fglso[3],
                                    ifelse(grepl(nolso[4], code), fglso[4], 
                                  ifelse(grepl(nolso[5], code), fglso[5], 
                                ifelse(grepl(nolso[6], code), fglso[6], 
                                 ifelse(grepl(nolso[7], code), fglso[7],
                                ifelse(grepl(nolso[8], code), fglso[8], 
                                ifelse(grepl(nolso[9], code), fglso[9],
                                  ifelse(grepl(nolso[10], code), fglso[10], 
                                ifelse(grepl(nolso[11], code), fglso[11],
                                ifelse(grepl(nolso[12], code), fglso[12], 
                                ifelse(grepl(nolso[13], code), fglso[13], 
                                ifelse(grepl(nolso[14], code), fglso[14],
                                ifelse(grepl(nolso[15], code), fglso[15],
                              ifelse(grepl(nolso[16], code), fglso[16],
                                  ifelse(grepl(nolso[17], code), fglso[17],  
                                       ifelse(grepl(nolso[18], code), fglso[18],
                                      ifelse(grepl(nolso[19], code), fglso[19],
                                          ifelse(grepl(nolso[20], code), fglso[20], 
                                                           'NA')))))))))))))))))))))%>% 
                                               filter(!is.na(code))

LSOFCT <- LSOFCT %>%   mutate_at(vars(3:39), funs(as.numeric)) 


LSOFCT <- LSOFCT %>%
  mutate(SOP = reduce(select(.,
                             'WATER', 'PROTCNT' ,'FAT', 'CHOAVLDF','FIBTG',  'ASH'), `+`))

summary(LSOFCT$SOP)

```


##Conclusion

1) Energy: Most of the FCT used the ENERC values and conversion factor as established by FAO/INFOODS. Most of the differences were including calculation for kcal and/or kJ. Including ALC or not into the calculation. Mozambique kcal were calculated as kJ and applying a conversion factor (Energy, kJ/4,184). Gambia did not account for fibre and the conversion factor used for CHO was 3.75 (due to the calculation is based on monosaccharide equivalents). In addition, Tanzania used total carbohydrates, hence fibre was included into the CHO fraction (not accounting for differences in fibre conversion factors). Three FCT (eth, nga, uga) did not report the method used to calculate the energy content. This variable will be (re-)calculated following the equations:

Eq.1: ENERC - (kcal/100 g EP) = PROTCNT (g/100 g EP) x 4 + FAT (g/100 g EP) x 9 + CHOAVLDF (g/100 g EP) x 4 + FIBTG (g/100 g EP) x 2 + ALC (g/100 g EP) x 7]

Eq.2: ENERC - (kJ/10- g EP) = PROTCNT (g/100 g EP) x 17 + FAT (g/100 g EP) x 37 + CHOAVLDF (g/100 g EP) x 16 + FIBTG (g/100 g EP) x 8 + ALC (g/100 g EP) x 29]

2) Protein: All FCT that reported used similar approach. It was calculated using total nitrogen (NT) and either a general conversion factor (6.75) or specific conversion factors (XN). If NT information is available for those that used general conversion factor, we could re-calculate using the conversion factors. 

Eq.3: PROTCNT - (g/100 g EP) = nitrogen conversion factor (XN) × total nitrogen (NT) (g/100 g EP)

3) Fat: FAT - is the most common used and it refers to fat calculated using mixed solvent extraction. This was not initially compiled in FCT_QA.  

4) Carbohydrates: Most of the FCT calculated CHO as CHOAVLF (carbohydrates available) as per FAO/INFOODS recommendation with slight variability of the presence or absence of ALC (alcohol). Tanzania reported total carbohydrates (CHOTDF). While, Gambia FCT accounted for available CHO by summation and expressed as monosaccharide equivalents (CHOAVLM). MAFOODS reported total CHO by summation (CHOCSM/CHOTSM?). ETHFCT reported CHOT. According to FAO/INFOOD the preferred reporting is CHOAVL followed by CHOAVLF.  

5) Fibre: Most of the dataset reported total fibre (FIBTG), while MAFOODS reported FIBC (and marked as italic when FIBTG was available) and GMBFCT that reported FIBTS (the sum of non-digestible polysaccharides and lignin). According to the FAO/INFOODS the preferred reporting method is FIBGT followed by FIBTS. While FIBC should be phased out. 

